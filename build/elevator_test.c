
/* This file was autogenerated by 'ctemp' from  for class motorbank2. */


 
/***********************************************************************
 * elevator test:
 ***********************************************************************/
 

#include <freewpc.h>
#include <window.h>
#include <test.h>
#include "elevator.h"

// FIXME - font_render_string_right vertically offsets the text by 1 pixel (downwards)
// When this is removed removed all references to FR_WORKAROUND
#define FRSR_WORKAROUND 1

enum {
	FIRST_TEST = 0,
	UP  = FIRST_TEST,
	DOWN,
	STOP,
	LAST_TEST = STOP
} elevator_test_command;



char *elevator_test_short_names[] = {
	"UP",
	"DOWN",
	"STOP"
};

__boolean in_elevator_test;




void elevator_test_draw (void) {
	dmd_alloc_low_clean ();
	font_render_string_center (&font_var5, 64, 2, "ELEVATOR TEST");
	dmd_draw_horiz_line ((U16 *)dmd_low_buffer, 5);
	dmd_draw_horiz_line ((U16 *)dmd_low_buffer, 25);

	//display status of upper limit switch
			sprintf ("SW_ELEVATOR_HOLD");
			font_render_string_center (&font_var5, 64, 13, sprintf_buffer);
			if (switch_poll_logical (SW_ELEVATOR_HOLD) ) 	sprintf ("X");
			 else 										sprintf ("O"); 
			font_render_string_center (&font_var5, 20, 13, sprintf_buffer);

	//display status of lower limit switch
			sprintf ("SW_ELEVATOR_INDEX");
			font_render_string_center (&font_var5, 64, 20, sprintf_buffer);
			if (switch_poll_logical (SW_ELEVATOR_INDEX) ) 	sprintf ("X");
			 else 										sprintf ("O"); 
			font_render_string_center (&font_var5, 20, 20, sprintf_buffer);

	//name of currently running test
			sprintf(elevator_test_short_names[elevator_test_command]);
			font_render_string_left (&font_var5, 0, 27, sprintf_buffer);
	dmd_show_low ();
}




void elevator_test_init (void) { 
	elevator_test_command = UP; 
	in_elevator_test = TRUE;
	elevator_test_draw ();
}




void elevator_test_thread (void) {
	for (;;) {
		task_sleep (TIME_1S);  //this was set to run faster but seemed to cause problems
		elevator_test_draw ();
	}
}







//up test button pressed
void elevator_test_up (void) {
	if (elevator_test_command < LAST_TEST) elevator_test_command++;
	elevator_test_draw ();
}



//down test button pressed
void elevator_test_down (void) {
	if (elevator_test_command > FIRST_TEST) elevator_test_command--;
	elevator_test_draw ();
}


//escape test button pressed
void elevator_test_escape (void) {
	// stop everything
	elevator_stop();
	in_elevator_test = FALSE;
	window_pop();
}


//enter test button pressed
void elevator_test_enter (void) {
	sound_send (SND_TEST_ENTER);
  	switch (elevator_test_command) {
  		case UP:
			elevator_move_up();
			elevator_test_command = STOP;
  		break;
  		case DOWN:
			elevator_move_down();
			elevator_test_command = STOP;
  		break;
  		case STOP:
			elevator_stop();
			elevator_test_command = STOP;
  		break;
  	}
	elevator_test_draw ();
 }


CALLSET_ENTRY (elevator_test, SW_ELEVATOR_HOLD) {
	if (in_elevator_test) {
		elevator_stop();
		elevator_test_draw ();
	}
}



CALLSET_ENTRY (elevator_test, SW_ELEVATOR_INDEX) {
		if (in_elevator_test) {
			elevator_stop();
			elevator_test_draw ();
		}
}


struct window_ops elevator_test_window = {
	DEFAULT_WINDOW,
	.init = elevator_test_init,
	.draw = elevator_test_draw,
	.up = elevator_test_up,
	.down = elevator_test_down,
	.enter = elevator_test_enter,
	.escape = elevator_test_escape,
	.thread = elevator_test_thread,
};



struct menu elevator_test_item = {
	.name = "ELEVATOR TEST", // needs ELEVATOR for uppercase version of 'self' as test menu font doesn't have lower-case letters.
	.flags = M_ITEM,
	.var = { .subwindow = { &elevator_test_window, NULL } },
};




